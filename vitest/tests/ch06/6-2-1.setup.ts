import { beforeAll, afterAll, afterEach } from 'vitest';
import { server } from './6-2-1.server';

/**
 * 테스트 전체 시작 시 1회 실행
 * → MSW 네트워크 인터셉터를 활성화한다.
 *
 * 이 시점부터 발생하는 모든 HTTP 요청(axios, fetch, undici 등)은
 * 실제 네트워크로 나가지 않고 MSW 핸들러가 가로채서 응답을 반환한다.
 */
beforeAll(() => {
  server.listen({
    /**
     * 실무 필수 옵션
     *
     * 핸들러가 정의되지 않은 요청이 발생하면:
     * - 기본값(warn): 콘솔 경고만 출력하고 실제 네트워크 요청을 그대로 보냄 (⚠ 매우 위험)
     * - error: 즉시 테스트 실패 처리 → 외부 API 호출 사고를 구조적으로 차단
     *
     * 즉, "모든 외부 요청은 반드시 Mock 되어 있어야 한다"는 규칙을 강제한다.
     */
    onUnhandledRequest: 'error',
  });
});

/**
 * 각 테스트가 끝날 때마다 실행
 * → 테스트 중 임시로 변경된 핸들러 상태를 초기화한다.
 *
 * server.use(...) 를 이용해 특정 테스트에서만
 * 에러 응답, 타임아웃, 다른 데이터 등을 주입하는 경우,
 * 이 설정이 없으면 다음 테스트까지 영향이 전파되어
 * 테스트 순서에 따라 결과가 달라지는 문제가 발생한다.
 *
 * resetHandlers()는 최초 setupServer(...)에 등록한
 * 기본 핸들러 상태로 되돌리는 역할을 한다.
 */
afterEach(() => {
  server.resetHandlers();
});

/**
 * 테스트 전체 종료 시 1회 실행
 * → MSW 네트워크 인터셉터를 완전히 제거한다.
 *
 * 이후 실행되는 코드나 다른 테스트 러너, E2E 테스트 등에서는
 * HTTP 요청이 다시 실제 네트워크로 정상 전송된다.
 *
 * close()를 호출하지 않으면 테스트 종료 이후에도
 * 인터셉터가 남아 예기치 않은 통신 차단 문제가 발생할 수 있다.
 */
afterAll(() => {
  server.close();
});

////////////////////////////////////////
// vite.config.ts 설정
////////////////////////////////////////

// 모든 테스트 전에 MSW 서버가 자동으로 켜집니다
//setupFiles: ['./tests/ch06/5-2-1.setup.ts'],
